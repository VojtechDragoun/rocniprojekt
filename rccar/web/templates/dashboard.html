{% extends "base.html" %}

{% block title %}RCcar – Dashboard{% endblock %}

{% block content %}
  <div class="card">
    <h1>Dashboard – ovládání serva + historie jízd</h1>

    <p>
      Drž <b>A</b> = vlevo 45°, drž <b>D</b> = vpravo 45°.
      Po puštění se servo vrátí do středu.
    </p>

    <!-- VÝBĚR AUTA (M:N users ↔ cars) -->
    {% if cars and cars|length > 0 %}
      <div style="margin: 10px 0 14px 0;">
        <label for="carSelect" style="display:block; margin-bottom:6px;">
          Vyber auto:
        </label>

        <select id="carSelect" style="padding:10px 12px; border-radius:12px;">
          {% for c in cars %}
            <option value="{{ c.id }}" {% if c.id == active_car_id %}selected{% endif %}>
              {{ c.name }}
            </option>
          {% endfor %}
        </select>

        <span id="carStatus" style="margin-left:10px; color:#cbd5e1;"></span>
      </div>
    {% else %}
      <p style="color:#fca5a5;">
        <b>Nemáš přiřazené žádné auto.</b>
        Přihlas se jako admin a přiřaď auto uživateli (tabulka user_cars).
      </p>
    {% endif %}

    <!-- OVLÁDÁNÍ MYŠÍ -->
    <div style="display:flex; gap:10px; flex-wrap:wrap; margin: 14px 0;">
      <button id="btnLeft" class="btn" type="button">⬅️ Left (drž)</button>
      <button id="btnRight" class="btn" type="button">➡️ Right (drž)</button>

      <span id="status" style="margin-left:10px; color:#cbd5e1; align-self:center;"></span>
    </div>

    <hr style="opacity:0.25; margin: 16px 0;">

    <!-- HISTORIE JÍZD -->
    {% if rides and rides|length > 0 %}
      <table>
        <thead>
          <tr>
            <th>Uživatel</th>
            <th>Auto</th>
            <th>Délka jízdy (s)</th>
            <th>Datum</th>
          </tr>
        </thead>
        <tbody>
          {% for r in rides %}
            <tr>
              <td>{{ r.username }}</td>
              <td>{{ r.car_name }}</td>
              <td>{{ r.duration_sec }}</td>
              <td>{{ r.created_at }}</td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    {% else %}
      <p><em>Zatím nejsou v databázi žádné jízdy.</em></p>
      <p>Pro test: <a href="{{ url_for('add_demo_ride') }}">Přidat demo jízdu</a></p>
    {% endif %}
  </div>

  <script>
    /*
      dashboard.js (inline)
      - posílá příkazy na /api/control (Flask)
      - Flask to pošle přes Serial do Arduino
      - navíc vybíráš aktivní auto přes /api/select_car (uloží se do session)

      Příkazy:
        STEER:L / STEER:R / STEER:C
    */

    const statusEl = document.getElementById("status");
    const carSelect = document.getElementById("carSelect");
    const carStatus = document.getElementById("carStatus");

    async function sendCmd(cmd) {
      try {
        const res = await fetch("/api/control", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ cmd })
        });

        if (res.status === 401) {
          statusEl.textContent = "❌ Nepřihlášen – nejdřív se přihlas.";
          return;
        }

        const data = await res.json();
        if (!res.ok) {
          statusEl.textContent = "❌ Chyba: " + (data.error || res.status);
          return;
        }

        statusEl.textContent = "✅ Odesláno: " + cmd;
      } catch (e) {
        statusEl.textContent = "❌ Network error: " + e;
      }
    }

    async function selectCar(car_id) {
      if (!carStatus) return;
      try {
        const res = await fetch("/api/select_car", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ car_id })
        });

        const data = await res.json();
        if (!res.ok) {
          carStatus.textContent = "❌ " + (data.error || res.status);
          return;
        }

        carStatus.textContent = "✅ Aktivní auto nastaveno";
      } catch (e) {
        carStatus.textContent = "❌ Network error: " + e;
      }
    }

    if (carSelect) {
      carSelect.addEventListener("change", () => selectCar(carSelect.value));
    }

    // -------------------------
    // OVLÁDÁNÍ MYŠÍ (drž = zatoč, pust = střed)
    // -------------------------
    const btnLeft = document.getElementById("btnLeft");
    const btnRight = document.getElementById("btnRight");

    btnLeft.addEventListener("mousedown", () => sendCmd("STEER:L"));
    btnLeft.addEventListener("mouseup", () => sendCmd("STEER:C"));
    btnLeft.addEventListener("mouseleave", () => sendCmd("STEER:C"));

    btnRight.addEventListener("mousedown", () => sendCmd("STEER:R"));
    btnRight.addEventListener("mouseup", () => sendCmd("STEER:C"));
    btnRight.addEventListener("mouseleave", () => sendCmd("STEER:C"));

    // -------------------------
    // OVLÁDÁNÍ KLÁVESNICÍ (A/D držení + auto-center)
    // -------------------------
    const held = { a:false, d:false };

    window.addEventListener("keydown", (e) => {
      const k = e.key.toLowerCase();
      if (k === "a" || k === "d") e.preventDefault();

      if (k === "a" && !held.a) {
        held.a = true;
        sendCmd("STEER:L");
      }

      if (k === "d" && !held.d) {
        held.d = true;
        sendCmd("STEER:R");
      }
    }, { passive:false });

    window.addEventListener("keyup", (e) => {
      const k = e.key.toLowerCase();

      if (k === "a") {
        held.a = false;
        sendCmd("STEER:C");
      }

      if (k === "d") {
        held.d = false;
        sendCmd("STEER:C");
      }
    });

    // pojistka: Alt+Tab / ztráta focusu => vrať střed
    window.addEventListener("blur", () => {
      held.a = held.d = false;
      sendCmd("STEER:C");
    });
  </script>
{% endblock %}