{% extends "base.html" %}

{% block title %}RCcar – Dashboard{% endblock %}

{% block content %}
  <div class="card">
    <h1>Dashboard – řízení servem + historie jízd</h1>

    <p>
      Drž <b>A</b> = vlevo 45°, drž <b>D</b> = vpravo 45°.
      Po puštění se servo automaticky vrátí do středu.
    </p>

    <!-- OVLÁDÁNÍ -->
    <div style="display:flex; gap:10px; flex-wrap:wrap; margin: 14px 0;">
      <button id="btnLeft" class="btn" type="button">⬅️ Left (drž)</button>
      <button id="btnRight" class="btn" type="button">➡️ Right (drž)</button>
      <span id="status" style="margin-left:10px; color:#cbd5e1; align-self:center;"></span>
    </div>

    <hr style="opacity:0.25; margin: 16px 0;">

    <!-- HISTORIE JÍZD -->
    {% if rides and rides|length > 0 %}
      <table>
        <thead>
          <tr>
            <th>Uživatel</th>
            <th>Délka jízdy (s)</th>
            <th>Datum</th>
          </tr>
        </thead>
        <tbody>
          {% for r in rides %}
            <tr>
              <td>{{ r.username }}</td>
              <td>{{ r.duration_sec }}</td>
              <td>{{ r.created_at }}</td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    {% else %}
      <p><em>Zatím nejsou v databázi žádné jízdy.</em></p>
      <p>Pro test: <a href="{{ url_for('add_demo_ride') }}">Přidat demo jízdu</a></p>
    {% endif %}
  </div>

  <script>
    // --- jednoduchý status řádek ---
    const statusEl = document.getElementById("status");

    async function sendCmd(cmd) {
      try {
        const res = await fetch("/api/control", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ cmd })
        });

        if (res.status === 401) {
          statusEl.textContent = "❌ Nepřihlášen – nejdřív se přihlas.";
          return;
        }

        const data = await res.json();
        if (!res.ok) {
          statusEl.textContent = "❌ Chyba: " + (data.error || res.status);
          return;
        }

        statusEl.textContent = "✅ Odesláno: " + cmd;
      } catch (e) {
        statusEl.textContent = "❌ Network error: " + e;
      }
    }

    // ---------- Myš (drž = zatoč, pust = střed) ----------
    const btnLeft = document.getElementById("btnLeft");
    const btnRight = document.getElementById("btnRight");

    btnLeft.addEventListener("mousedown", () => sendCmd("STEER:L"));
    btnLeft.addEventListener("mouseup", () => sendCmd("STEER:C"));
    btnLeft.addEventListener("mouseleave", () => sendCmd("STEER:C"));

    btnRight.addEventListener("mousedown", () => sendCmd("STEER:R"));
    btnRight.addEventListener("mouseup", () => sendCmd("STEER:C"));
    btnRight.addEventListener("mouseleave", () => sendCmd("STEER:C"));

    // ---------- Klávesnice (A/D držení) ----------
    const held = { a: false, d: false };

    window.addEventListener("keydown", (e) => {
      const k = e.key.toLowerCase();
      if (k === "a" || k === "d") e.preventDefault();

      if (k === "a" && !held.a) {
        held.a = true;
        sendCmd("STEER:L");
      }

      if (k === "d" && !held.d) {
        held.d = true;
        sendCmd("STEER:R");
      }
    }, { passive:false });

    window.addEventListener("keyup", (e) => {
      const k = e.key.toLowerCase();

      if (k === "a") {
        held.a = false;
        sendCmd("STEER:C");
      }

      if (k === "d") {
        held.d = false;
        sendCmd("STEER:C");
      }
    });

    // pojistka: při ztrátě focusu vrátit střed
    window.addEventListener("blur", () => {
      held.a = held.d = false;
      sendCmd("STEER:C");
    });
  </script>
{% endblock %}