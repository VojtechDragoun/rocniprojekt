{% extends "base.html" %}

{% block title %}RCcar â€“ Dashboard{% endblock %}

{% block content %}
  <div class="card">
    <h1>Dashboard â€“ ovlÃ¡dÃ¡nÃ­ + historie jÃ­zd</h1>
    <p>
      OvlÃ¡dÃ¡nÃ­: drÅ¾ <b>W</b> pro jÃ­zdu (max), pusÅ¥ pro stop.
      Stisk <b>A</b> = vlevo 45Â°, <b>D</b> = vpravo 45Â°, tlaÄÃ­tko â€StÅ™edâ€œ vrÃ¡tÃ­ volant.
    </p>

    <!-- OVLÃDÃNÃ MYÅ Ã -->
    <div style="display:flex; gap:10px; flex-wrap:wrap; margin: 14px 0;">
      <!-- DrÅ¾et = jede, pustit = stop -->
      <button id="btnForward" class="btn" type="button">ğŸš— Forward (drÅ¾)</button>

      <!-- JednorÃ¡zovÃ© stisky -->
      <button id="btnLeft" class="btn" type="button">â¬…ï¸ Left (45Â°)</button>
      <button id="btnCenter" class="btn" type="button">ğŸ¯ Center</button>
      <button id="btnRight" class="btn" type="button">â¡ï¸ Right (45Â°)</button>

      <span id="status" style="margin-left:10px; color:#cbd5e1; align-self:center;"></span>
    </div>

    <hr style="opacity:0.25; margin: 16px 0;">

    <!-- HISTORIE JÃZD -->
    {% if rides and rides|length > 0 %}
      <table>
        <thead>
          <tr>
            <th>UÅ¾ivatel</th>
            <th>DÃ©lka jÃ­zdy (s)</th>
            <th>Datum</th>
          </tr>
        </thead>
        <tbody>
          {% for r in rides %}
            <tr>
              <td>{{ r.username }}</td>
              <td>{{ r.duration_sec }}</td>
              <td>{{ r.created_at }}</td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    {% else %}
      <p><em>ZatÃ­m nejsou v databÃ¡zi Å¾Ã¡dnÃ© jÃ­zdy.</em></p>
      <p>Pro test: <a href="{{ url_for('add_demo_ride') }}">PÅ™idat demo jÃ­zdu</a></p>
    {% endif %}
  </div>

  <script>
    /*
      dashboard.js (inline)
      ====================
      - PosÃ­lÃ¡ pÅ™Ã­kazy na Flask endpoint /api/control
      - Ten je pak pÅ™epoÅ¡le do ESP32 pÅ™es Serial

      PÅ™Ã­kazy, kterÃ© budeme posÃ­lat (string):
        "W:1"           -> pohon max ON
        "W:0"           -> pohon STOP
        "STEER:L"       -> volant vlevo 45Â°
        "STEER:R"       -> volant vpravo 45Â°
        "STEER:C"       -> volant stÅ™ed
    */

    const statusEl = document.getElementById("status");

    async function sendCmd(cmd) {
      try {
        const res = await fetch("/api/control", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ cmd })
        });

        // Pokud uÅ¾ivatel nenÃ­ pÅ™ihlÃ¡Å¡en, backend vrÃ¡tÃ­ 401
        if (res.status === 401) {
          statusEl.textContent = "âŒ NepÅ™ihlÃ¡Å¡en â€“ nejdÅ™Ã­v se pÅ™ihlas.";
          return;
        }

        const data = await res.json();
        if (!res.ok) {
          statusEl.textContent = "âŒ Chyba: " + (data.error || res.status);
          return;
        }

        statusEl.textContent = "âœ… OdeslÃ¡no: " + cmd;
      } catch (e) {
        statusEl.textContent = "âŒ Network error: " + e;
      }
    }

    // -------------------------
    // OVLÃDÃNÃ MYÅ Ã
    // -------------------------
    const btnForward = document.getElementById("btnForward");
    const btnLeft = document.getElementById("btnLeft");
    const btnCenter = document.getElementById("btnCenter");
    const btnRight = document.getElementById("btnRight");

    // Forward: drÅ¾enÃ­ myÅ¡i = W:1, puÅ¡tÄ›nÃ­ = W:0
    btnForward.addEventListener("mousedown", () => sendCmd("W:1"));
    btnForward.addEventListener("mouseup", () => sendCmd("W:0"));
    btnForward.addEventListener("mouseleave", () => sendCmd("W:0")); // kdyÅ¾ odjedeÅ¡ myÅ¡Ã­ pryÄ, stop
    btnForward.addEventListener("touchstart", (e) => { e.preventDefault(); sendCmd("W:1"); }, { passive:false });
    btnForward.addEventListener("touchend",   (e) => { e.preventDefault(); sendCmd("W:0"); }, { passive:false });

    // Steer: klik = jednorÃ¡zovÃ© nastavenÃ­
    btnLeft.addEventListener("click", () => sendCmd("STEER:L"));
    btnCenter.addEventListener("click", () => sendCmd("STEER:C"));
    btnRight.addEventListener("click", () => sendCmd("STEER:R"));

    // -------------------------
    // OVLÃDÃNÃ KLÃVESNICÃ
    // -------------------------
    // Chceme:
    // - W: pÅ™i stisku W -> W:1, pÅ™i uvolnÄ›nÃ­ -> W:0
    // - A/D: jednorÃ¡zovÃ© (na jeden stisk), ne spam pÅ™i drÅ¾enÃ­
    const held = {
      w: false,
      a: false,
      d: false,
    };

    window.addEventListener("keydown", (e) => {
      // aÅ¥ nÃ¡m to nescrolluje strÃ¡nku u nÄ›kterÃ½ch klÃ¡ves
      if (["w","a","d"," "].includes(e.key.toLowerCase())) e.preventDefault();

      const k = e.key.toLowerCase();

      if (k === "w") {
        if (!held.w) {
          held.w = true;
          sendCmd("W:1");
        }
      }

      // A/D chceme jen jednou (ne opakovÃ¡nÃ­ pÅ™i drÅ¾enÃ­)
      if (k === "a") {
        if (!held.a) {
          held.a = true;
          sendCmd("STEER:L");
        }
      }

      if (k === "d") {
        if (!held.d) {
          held.d = true;
          sendCmd("STEER:R");
        }
      }

      // mezernÃ­k jako â€œstÅ™edâ€ (hodÃ­ se)
      if (k === " ") {
        sendCmd("STEER:C");
      }
    }, { passive:false });

    window.addEventListener("keyup", (e) => {
      const k = e.key.toLowerCase();

      if (k === "w") {
        held.w = false;
        sendCmd("W:0");
      }
      if (k === "a") held.a = false;
      if (k === "d") held.d = false;
    });
  </script>
{% endblock %}
